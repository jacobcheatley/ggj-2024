<!DOCTYPE html>
<html>
    <head>
        <title>Server - Comedy Court</title>
        <script src="static/script.js"></script>
    </head>
    <body>
        <h1>Comedy Court Server</h1>
        <div>
            <h1 id="heading">Connecting...</h1>
            <p id="toast">...</p>
            <button id="submit">Start</button>
        </div>

        <script>
            // Constants
            let MAX_PLAYERS = 2;

            // Elements
            let heading_element = document.getElementById("heading");
            let toast_element = document.getElementById("toast")
            let submit_button = document.getElementById("submit");

            // Local Variables
            let data = {
                ws: null,
                players: [],
                players_submitted_jokes: {},
                joke_data: null,
                theme: null,
            }

            // Helper Functions
            let toast = (message, color) => {
                console.log(`Toast ${message}`);
                toast_element.textContent = message;
                if (color != undefined) {
                    toast_element.style.color = color;
                } else {
                    toast_element.style.color = "black";
                }
            }

            // State Machine Setup
            let state_machine = new StateMachine();
            let state_list = [
                new State(
                    "INIT",
                    {
                        enter: () => { 
                            submit_button.style.display = "block";
                            submit_button.textContent = "Start";
                            
                            data = {
                                ws: null,
                                players: [],
                                players_submitted_jokes: {},
                                joke_data: null,
                                theme: null,
                            }

                            heading_element.textContent = "Connecting...";
                            submit_button.style.display = "block";

                            let ws = new WebSocket(`ws://${window.location.host}/ws_server`);
                            ws.onmessage = e => {
                                let j = JSON.parse(e.data);
                                console.log(`Message: ${JSON.stringify(j)}`);
                                switch (j.type) {
                                    case "player_join":
                                        break
                                    case "players":
                                        data.players = j.data;
                                        toast(`Players ${data.players.length}/${MAX_PLAYERS} (${data.players.join(", ")})`);
                                        break;
                                    case "submitted_joke":
                                        let player = j.data.player;
                                        data.players_submitted_jokes[player] = true
                                        toast(`Submitted jokes: ${JSON.stringify(data.players_submitted_jokes)}`);
                                        break;
                                    case "set_jokes":
                                        data.joke_data = j.data;
                                        break;
                                    case "set_theme":
                                        data.theme = j.data;
                                    case "debug":
                                        console.debug(j.data);
                                        break;
                                    case "error":
                                        toast(j.data, "red");
                                        break;
                                    case "message":
                                        toast(j.data);
                                        break;
                                    case "state":
                                        state_machine.transition(j.data);
                                        break;
                                    default:
                                        console.warn(`Unsupported ${JSON.stringify(j)}`);
                                        break;
                                }
                            };
                            ws.onopen = e => {
                                data.ws = ws;
                                data.ws.send(JSON.stringify({"type": "state_set", "data": "INIT"}));
                            };
                            ws.onclose = e => {
                                console.log(`Close ${e.data}`);
                                data.ws = null;
                            };
                        }
                    }
                ),
                new State(
                    "WAIT_FOR_PLAYERS",
                    {
                        enter: () => {
                            data.ws.send(JSON.stringify({"type": "state_set", "data": "WAIT_FOR_PLAYERS"}));

                            heading_element.textContent = "Waiting for Players...";
                        },
                        submit: () => {
                            if (data.players.length < 2)
                                return;
                            
                            data.ws.send(JSON.stringify({"type": "start"}));
                        }
                    }
                ),
                new State(
                    "START_GAME",
                    {
                        enter: () => {
                            data.ws.send(JSON.stringify({"type": "state_set", "data": "START_GAME"}));

                            heading_element.textContent = "Start Game (Play Animations Here)";
                            submit_button.style.display = "none";

                            // Mock start game animation
                            setTimeout(() => {
                                data.ws.send(JSON.stringify({"type": "finished_start"}));
                            }, 3000);
                        },
                        exit: () => {
                            submit_button.style.display = "block";
                        }
                    }
                ),
                new State(
                    "ASK_FOR_JOKES",
                    {
                        enter: () => {
                            data.ws.send(JSON.stringify({"type": "state_set", "data": "ASK_FOR_JOKES"}));

                            submit_button.style.display = "block";
                            submit_button.textContent = "Skip";
                            heading_element.textContent = "Asking for Joke";
                            toast(`JESTERS! Tell me a joke about ${data.theme}.`);
                        },
                        submit: () => {
                            data.ws.send(JSON.stringify({"type": "skip"}));
                        }
                    }
                ),
                new State(
                    "TELL_JOKES",
                    {
                        enter: () => {
                            data.ws.send(JSON.stringify({"type": "state_set", "data": "TELL_JOKES"}));

                            data.players.forEach(player_name => {
                                let player_joke = data.joke_data[player_name];
                                console.log(`Player ${player_name}\nJoke ${JSON.stringify(player_joke)}`);
                                // TODO animations, waiting, rating etc
                            });
                        }
                    }
                )
            ]
            state_machine.add_states(state_list);
            state_machine.transition("INIT");

            // Event Listeners
            submit_button.addEventListener("click", () => state_machine.submit());
        </script>
    </body>
</html>