<!DOCTYPE html>
<html>
    <head>
        <title>Client - Jest Fest</title>
        <script src="static/script.js"></script>
    </head>
    <body>
        <h1>Jest Fest Client</h1>
        <div>
            <h1 id="heading">Enter Name</h1>
            <p id="toast">...</p>
            <input type="text" id="input-text" autocomplete="off" />
            <button id="submit">Submit</button>
        </div>

        <script>
            // Elements
            let heading_element = document.getElementById("heading");
            let toast_element = document.getElementById("toast")
            let input_element = document.getElementById("input-text");
            let submit_button = document.getElementById("submit");

            // Local Variables
            let data = {
                name: null,
                ws: null
            }

            // Helper Functions
            let toast = (message, color) => {
                console.log(`Toast ${message}`);
                toast_element.textContent = message;
                if (color != undefined) {
                    toast_element.style.color = color;
                } else {
                    toast_element.style.color = "black";
                }
            }

            // State Machine Setup
            let state_machine = new StateMachine();
            let state_list = [
                new State(
                    "NAME",
                    {
                        submit: () => { 
                            console.log("NAME SUBMIT");

                            let name = input_element.value;
                            if (name == undefined || name == '' || name.length == 0)
                            {
                                toast("Name can't be empty", "red");
                                return;
                            }
                            name = encodeURIComponent(name.toUpperCase());

                            let ws = new WebSocket(`ws://${window.location.host}/ws/${name}`);
                            ws.onmessage = e => {
                                let j = JSON.parse(e.data);
                                console.log(`Message: ${JSON.stringify(j)}`);
                                switch (j.type) {
                                    case "name":
                                        data.name = j.data;
                                        document.title = `Client - ${data.name}`;
                                        break;
                                    case "debug":
                                        console.debug(j.data);
                                        break;
                                    case "error":
                                        toast(j.data, "red");
                                        break;
                                    case "message":
                                        toast(j.data);
                                        break;
                                    case "state":
                                        state_machine.transition(j.data);
                                        break;
                                    default:
                                        console.warn(`Unsupported ${JSON.stringify(j)}`);
                                        break;
                                }
                            };
                            ws.onclose = e => {
                                console.log(`Close ${e.data}`);
                                data.ws = null;
                            }
                            data.ws = ws;
                        },
                        enter: () => {
                            heading_element.textContent = "Enter Name";
                            input_element.value = "";
                        }
                    }
                ),
                new State(
                    "WAIT",
                    {
                        enter: () => {
                            heading_element.textContent = "Waiting..."
                            input_element.style.display = "none";
                            submit_button.style.display = "none";
                            toast("Waiting...");

                        },
                        exit: () => {
                            input_element.style.display = "block";
                            submit_button.style.display = "block";
                            toast("");
                        }
                    }
                ),
                new State(
                    "JOKE",
                    {
                        submit: () => {
                            console.log("JOKE SUBMIT");

                            let joke = input_element.value;
                            if (joke == undefined || joke == '' || joke.length == 0)
                            {
                                toast("Joke can't be empty", "red");
                                return;
                            }
                            data.ws.send(JSON.stringify({"type": "joke", "data": joke}));

                            state_machine.transition("WAIT");
                        },
                        enter: () => {
                            heading_element.textContent = "Enter Joke";
                            input_element.value = "";
                        }
                    }
                ),
            ]
            state_machine.add_states(state_list);
            state_machine.transition("NAME");

            // Event Listeners
            submit_button.addEventListener("click", () => state_machine.submit());
            input_element.addEventListener("keypress", (e) => {
                if (e.key == 'Enter') {
                    state_machine.submit();
                }
            });
        </script>
    </body>
</html>