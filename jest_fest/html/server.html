<!DOCTYPE html>
<html>
    <head>
        <title>Server - Jest Fest</title>
        <script src="static/script.js"></script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Playfair Display">
        <style>
            body {
                font-family: 'Playfair Display';
            }

            #game-area {
                position: absolute;
                top: 0;
                left: 0;
                width: 3840px;
                height: 2160px;
                /* background-color: red; */
            }

            #game-background, #game-text, #game-jesters {
                position: absolute;
                width: 100%;
                height: 100%;
            }

            #game-background {
                background-image: url("/static/images/backgrounds/courtroom/0.png");
                background-size: 100%;
                width: 100%;
                height: 100%;
            }

            #game-text {
                text-align: center;
                width: 100%;
            }

            #heading {
                color: white;
                font-size: 100px;
            }

            #toast {
                color: white;
                font-size: 100px;
            }

            #submit {
                font-size: 100px;
                font-family: 'Playfair Display';
            }

            .jester {
                position: absolute;
                width: 400px;
                height: 600px;
            }

            .jester img {
                position: absolute;
                display: block;
            }

            .jester-name {
                position: relative;
                top: 600px;
                left: 50%;
                transform: translateX(-50%);
                width: fit-content;
                overflow: visible;
                text-align: center;
                font-size: 60px;
                background-color: rgba(255, 255, 255, 0.5);
                border-radius: 20px;
                padding: 10px;
                margin: 10px;
                display: block;
                border: solid black 8px;
            }

            #game-speech {
                font-size: 100px;
                position: absolute;
                width: 100%;
                text-align: center;
                background-color: rgba(255, 255, 255, 0.5);
                border-radius: 20px;
                padding: 10px;
                margin: 10px;
                display: block;
                border: solid black 8px;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <h1>Jest Fest Server</h1>
        <div id="game-area">
            <div id="game-background"></div>
            <div id="game-text">
                <h1 id="heading">Connecting...</h1>
                <p id="toast">...</p>
                <button id="submit">Start</button>
            </div>
            <div id="game-jesters"></div>
            <div id="game-king"></div>
            <div id="game-speech"></div>
        </div>
        <audio id="music">
            <source id="music-source" src="/static/music/music_0.mp3" type="audio/mpeg">
        </audio>

        <script>
            window.onload = async () => {
            // Set up music
            let music_element = document.getElementById("music");
            let music_source_element = document.getElementById("music-source");
            function music() {
                music_element.play();
                document.removeEventListener("click", music);
            }
            window.addEventListener("click", music);
            music_element.addEventListener("ended", () => {
                let music_index = random_int(0, 3);
                music_source_element.src = `/static/music/music_${music_index}.mp3`;
                music_element.currentTime = 0;
                music_element.play();
            });

            // Constants
            let MAX_PLAYERS = 2;

            // Elements
            let heading_element = document.getElementById("heading");
            let toast_element = document.getElementById("toast")
            let submit_button = document.getElementById("submit");
            let game_jesters_element = document.getElementById("game-jesters");

            // Animations
            let background_path = "/images/backgrounds/0.png";

            // Animatables - Jesters
            let jester_start_x = 1820;
            let jester_start_y = 1350;
            let jester_spacing = 300;

            class Animatable {
                constructor(class_name, parent_element) {
                    // Create elements
                    this.element = document.createElement("div");
                    this.element.classList.add(class_name);
                    this.element_layers = [document.createElement("img"), document.createElement("img"), document.createElement("img")];
                    this.element_layers.forEach(e => {
                        this.element.appendChild(e);
                    });
                    parent_element.appendChild(this.element);

                    // Animatable Properties
                    this._image_path = "/images/blank";
                    this._image_frame = 0;
                    this._num_layers = 1;
                }

                get image_path() {
                    return this._image_path;
                }
                set image_path(value) {
                    this._image_path = value;
                    this.draw();
                }
                get image_frame() {
                    return this._image_frame;
                }
                set image_frame(value) {
                    this._image_frame = value;
                    this.draw();
                }
                get num_layers() {
                    return this._num_layers;
                }
                set num_layers(value) {
                    this._num_layers = value;
                    this.draw();
                }

                set_position(x, y) {
                    this.element.style.left = `${x}px`;
                    this.element.style.top = `${y}px`;
                }

                draw() {
                    // console.log(`DRAW ${this.image_path} ${this.image_frame} ${this.num_layers}`);
                    for (let i = 0; i < this.element_layers.length; i++) {
                        if (i < this.num_layers) {
                            this.element_layers[i].src = `${this.image_path}/${i}_${this.image_frame}.png`;
                        } else {
                            this.element_layers[i].src = "";
                        }
                    }
                }

                start_loop(image_path, num_frames, num_layers, ms) {
                    console.log(`Starting loop ${image_path}`);
                    clearInterval(this.loop_interval);
                    let current_frame = 0;
                    this.loop_interval = setInterval(() => {
                        this.image_path = image_path;
                        this.image_frame = current_frame;
                        this.num_layers = num_layers;
                        current_frame += 1;
                        current_frame %= num_frames;
                    }, ms);
                }

                stop_loop() {
                    clearInterval(this.loop_interval);
                }

                set_image(image_path, image_frame, num_layers) {
                    this.stop_loop();
                    this.image_path = image_path;
                    this.image_frame = image_frame == undefined ? 0 : image_frame;
                    this.num_layers = num_layers == undefined ? 1 : num_layers;
                }
            }

            class Jester extends Animatable {
                constructor(name, index) {
                    super("jester", game_jesters_element);

                    this.name = name;
                    this.index = index;
                    this.home_position_x = jester_start_x + this.index * jester_spacing;
                    this.home_position_y = jester_start_y;

                    this.name_element = document.createElement("div");
                    this.name_element.classList.add("jester-name");
                    this.name_element.textContent = this.name;
                    this.element.appendChild(this.name_element);
                    
                    this.set_position(this.home_position_x, this.home_position_y);
                    this.set_image("/images/jesters/jesto/still");
                }
            }

            class Speech {
                constructor() {
                    this.element = document.getElementById("game-speech");
                    this.element.style.display = "none";
                }

                async say(name, text, src) {
                    return new Promise((resolve, reject) => {
                        if (src == undefined) {
                            src = "/static/sound/placeholder.mp3";
                        }

                        this.element.textContent = `${name}: ${text}`;
                        this.element.style.display = "block";
                        let audio = new Audio(src);
                        audio.play();
                        audio.onended = () => {
                            this.element.style.display = "none";
                            resolve();
                        };
                    })
                }
            }

            // Local Variables
            let data = {
                ws: null,
                players: [],
                players_submitted_jokes: {},
                joke_data: null,
                theme: null,
            }
            let jesters = {};

            // Helper Functions
            let toast = (message, color) => {
                console.log(`Toast ${message}`);
                toast_element.textContent = message;
                if (color != undefined) {
                    toast_element.style.color = color;
                } else {
                    toast_element.style.color = "black";
                }
            }

            let speech = new Speech();

            // State Machine Setup
            let state_machine = new StateMachine();
            let state_list = [
                new State(
                    "INIT",
                    {
                        enter: async () => { 
                            data = {
                                ws: null,
                                players: [],
                                players_submitted_jokes: {},
                                joke_data: null,
                                theme: null,
                            }

                            heading_element.textContent = "Connecting...";
                            submit_button.style.display = "inline-block";
                            submit_button.textContent = "Start";

                            let ws = new WebSocket(`ws://${window.location.host}/ws_server`);
                            ws.onmessage = async e => {
                                let j = JSON.parse(e.data);
                                console.log(`Message: ${JSON.stringify(j)}`);
                                switch (j.type) {
                                    case "player_join":
                                        jesters[j.data] = new Jester(j.data, Object.keys(jesters).length);
                                        break
                                    case "players":
                                        data.players = j.data;
                                        toast(`Players ${data.players.length}/${MAX_PLAYERS} (${data.players.join(", ")})`);
                                        break;
                                    case "submitted_joke":
                                        let player = j.data.player;
                                        data.players_submitted_jokes[player] = true
                                        toast(`Submitted jokes: ${JSON.stringify(data.players_submitted_jokes)}`);
                                        jesters[j.data.player].start_loop("/images/jesters/jesto/ready", 3, 3, 400);
                                        break;
                                    case "set_jokes":
                                        data.joke_data = j.data;
                                        break;
                                    case "set_theme":
                                        data.theme = j.data;
                                    case "debug":
                                        console.debug(j.data);
                                        break;
                                    case "error":
                                        toast(j.data, "red");
                                        break;
                                    case "message":
                                        toast(j.data);
                                        break;
                                    case "state":
                                        await state_machine.transition(j.data);
                                        break;
                                    default:
                                        console.warn(`Unsupported ${JSON.stringify(j)}`);
                                        break;
                                }
                            };
                            ws.onopen = e => {
                                data.ws = ws;
                                data.ws.send(JSON.stringify({"type": "state_set", "data": "INIT"}));
                            };
                            ws.onclose = e => {
                                console.log(`Close ${e.data}`);
                                data.ws = null;
                            };
                        }
                    }
                ),
                new State(
                    "WAIT_FOR_PLAYERS",
                    {
                        enter: async () => {
                            data.ws.send(JSON.stringify({"type": "state_set", "data": "WAIT_FOR_PLAYERS"}));

                            heading_element.textContent = "Waiting for Players...";
                        },
                        submit: async () => {
                            if (data.players.length < 2)
                                return;
                            
                            data.ws.send(JSON.stringify({"type": "start"}));
                        }
                    }
                ),
                new State(
                    "START_GAME",
                    {
                        enter: async () => {
                            data.ws.send(JSON.stringify({"type": "state_set", "data": "START_GAME"}));

                            heading_element.textContent = "Start Game";
                            submit_button.style.display = "none";

                            data.ws.send(JSON.stringify({"type": "finished_start"}));
                        },
                        exit: async () => {
                            submit_button.style.display = "inline-block";
                        }
                    }
                ),
                new State(
                    "ASK_FOR_JOKES",
                    {
                        enter: async () => {
                            data.ws.send(JSON.stringify({"type": "state_set", "data": "ASK_FOR_JOKES"}));

                            submit_button.style.display = "none"; // Disabled skip button for now
                            submit_button.textContent = "Skip";
                            heading_element.textContent = "Asking for Joke";
                            console.log("STARTED SAY");
                            await speech.say("KING", `JESTERS! Tell me a joke about ${data.theme}.`, undefined);
                            console.log("FINISHED SAY");
                            data.players.forEach(player_name => {
                                jesters[player_name].start_loop("/images/jesters/jesto/writing", 3, 3, 200);
                            });
                        },
                        submit: async () => {
                            data.ws.send(JSON.stringify({"type": "skip"}));
                        }
                    }
                ),
                new State(
                    "TELL_JOKES",
                    {
                        enter: async () => {
                            data.ws.send(JSON.stringify({"type": "state_set", "data": "TELL_JOKES"}));

                            for (const player_name of data.players) {
                                let player_joke = data.joke_data[player_name];
                                console.log(`Player ${player_name}\nJoke ${JSON.stringify(player_joke)}`);
                                jesters[player_name].start_loop("/images/jesters/jesto/reading", 3, 3, 200);
                                await speech.say(player_name, player_joke.joke_text, player_joke.joke_audio);
                                await speech.say("KING", player_joke.response_text, player_joke.response_audio);
                                jesters[player_name].set_image("/images/jesters/jesto/still");
                            }
                        }
                    }
                )
            ]
            state_machine.add_states(state_list);
            await state_machine.transition("INIT");

            // Event Listeners
            submit_button.addEventListener("click", () => state_machine.submit());
            };
        </script>
    </body>
</html>